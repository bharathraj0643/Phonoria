name: Notify Discord of Vercel Deployment (frontend)

on:
  deployment_status:

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract commit and deployment info
        run: |
          COMMIT_SHA="${{ github.event.deployment.sha }}"
          BRANCH="${{ github.ref_name }}"
          AUTHOR=$(git show --format="%an" -s "$COMMIT_SHA" 2>/dev/null || echo "Unknown")
          RAW_MESSAGE=$(git show --format="%s" -s "$COMMIT_SHA" 2>/dev/null || echo "No message")
          MESSAGE=$(echo "$RAW_MESSAGE" | head -n 1 | cut -c1-72)

          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS="${{ github.event.deployment_status.state }}"
          ENVIRONMENT="${{ github.event.deployment.environment }}"
          URL="${{ github.event.deployment_status.environment_url }}"
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          COLOR=65280
          EMOJI="✅"
          if [ "$STATUS" != "success" ]; then
            COLOR=16711680
            EMOJI="❌"
          fi

          jq -n \
            --arg username "Vercel Bot" \
            --arg title "$EMOJI Deployment: $ENVIRONMENT" \
            --argjson color "$COLOR" \
            --arg description "**Branch:** ${BRANCH}\ | **Commit:** [${COMMIT_SHA:0:7}](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA}) | **Author:** ${AUTHOR}\n**Message:** ${MESSAGE}\n**URL:** ${URL} | [Workflow](${WORKFLOW_URL})" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              username: $username,
              embeds: [{
                title: $title,
                color: $color,
                description: $description,
                timestamp: $timestamp
              }]
            }' > payload.json

          curl -H "Content-Type: application/json" \
               -X POST \
               -d @payload.json \
               "$DISCORD_WEBHOOK_URL"
